#!/bin/sh
set -e

LOG="/var/log/aulalliure-wallpaper.log"
WALLPAPER="/usr/share/backgrounds/aulalliurex-book.jpg"
FALLBACK_WALLPAPER="/usr/share/backgrounds/aulalliure-books.jpg"
FLAG="$HOME/.config/aulalliure-wallpaper-set"

log() {
  printf "%s\n" "$*" >> "$LOG" 2>&1 || true
}

if [ -f "$FLAG" ]; then
  exit 0
fi

if [ -z "${DISPLAY:-}" ]; then
  log "[wallpaper] DISPLAY not set; skipping"
  exit 0
fi

if [ ! -f "$WALLPAPER" ] && [ -f "$FALLBACK_WALLPAPER" ]; then
  WALLPAPER="$FALLBACK_WALLPAPER"
fi

if [ ! -f "$WALLPAPER" ]; then
  log "[wallpaper] wallpaper file not found: $WALLPAPER"
  exit 0
fi

if ! command -v enlightenment_remote >/dev/null 2>&1; then
  log "[wallpaper] enlightenment_remote not available"
  exit 0
fi

if enlightenment_remote -default-bg-set "$WALLPAPER" >> "$LOG" 2>&1; then
  mkdir -p "$(dirname "$FLAG")"
  touch "$FLAG"
  log "[wallpaper] applied: $WALLPAPER"
else
  log "[wallpaper] failed to apply: $WALLPAPER"
fi
