#!/bin/sh

LOG=/target/var/log/aulalliure-late_command.log
mkdir -p /target/var/log /target/etc/apt/sources.list.d /target/usr/share/keyrings /target/usr/local/bin /target/usr/local/share/applications /target/etc/xdg/autostart /target/etc/firefox-esr/policies /target/etc/lightdm/lightdm.conf.d /target/etc/systemd/system/getty@tty1.service.d /target/etc/X11 /target/etc/aulalliure /target/home/aulalliure/.local/state
: > "$LOG"
echo "late_command start" >> "$LOG"

{
  cp -v /cdrom/aulalliure/bodhi/bodhi-archive-keyring.gpg /target/usr/share/keyrings/ || true
  cp -v /cdrom/aulalliure/bodhi/bodhi-repo.sources /target/etc/apt/sources.list.d/ || true
  cp -v /cdrom/aulalliure/usr/local/bin/educontrol-client-wrapper /target/usr/local/bin/ || true
  chmod 755 /target/usr/local/bin/educontrol-client-wrapper || true
  cp -v /cdrom/aulalliure/usr/local/share/applications/com.educontrol.Client.desktop /target/usr/local/share/applications/ || true
  cp -v /cdrom/aulalliure/etc/firefox-esr/policies/policies.json /target/etc/firefox-esr/policies/ || true
  printf "%s\n" "deb http://deb.debian.org/debian trixie main contrib non-free non-free-firmware" "deb http://deb.debian.org/debian trixie-updates main contrib non-free non-free-firmware" "deb http://security.debian.org/debian-security trixie-security main contrib non-free non-free-firmware" > /target/etc/apt/sources.list
  printf "%s\n" "[Seat:*]" "autologin-user=aulalliure" "autologin-user-timeout=0" "autologin-group=autologin" "user-session=enlightenment" "autologin-session=enlightenment" "greeter-session=lightdm-gtk-greeter" > /target/etc/lightdm/lightdm.conf.d/50-aulalliure-autologin.conf
  printf "%s\n" "[Seat:*]" "autologin-user=aulalliure" "autologin-user-timeout=0" "autologin-group=autologin" "user-session=enlightenment" "autologin-session=enlightenment" "greeter-session=lightdm-gtk-greeter" > /target/etc/lightdm/lightdm.conf
  printf "%s\n" "/usr/sbin/lightdm" > /target/etc/X11/default-display-manager
  ln -sf /lib/systemd/system/lightdm.service /target/etc/systemd/system/display-manager.service
  printf "%s\n" "[Service]" "ExecStart=" "ExecStart=-/sbin/agetty --autologin aulalliure --noclear %I \$TERM" > /target/etc/systemd/system/getty@tty1.service.d/override.conf
} >> "$LOG" 2>&1

in-target /bin/sh -c "printf '%s\n' 'lightdm shared/default-x-display-manager select lightdm' | debconf-set-selections" >> "$LOG" 2>&1 || true
in-target apt-get update >> "$LOG" 2>&1 || true
in-target /bin/sh -c "DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ca-certificates curl gnupg || true" >> "$LOG" 2>&1 || true
in-target /bin/sh -c 'set -e; mkdir -p /usr/share/keyrings /etc/apt/sources.list.d; curl -fsSL https://repo.edutictac.es/repo.key | gpg --dearmor --batch --yes --no-tty -o /usr/share/keyrings/edutictac-repo.gpg; chmod 0644 /usr/share/keyrings/edutictac-repo.gpg; printf "%s\n" "deb [arch=amd64 signed-by=/usr/share/keyrings/edutictac-repo.gpg] https://repo.edutictac.es trixie main" > /etc/apt/sources.list.d/edutictac.list; chmod 0644 /etc/apt/sources.list.d/edutictac.list' >> "$LOG" 2>&1 || true
in-target apt-get update >> "$LOG" 2>&1 || true
in-target /bin/sh -c "DEBIAN_FRONTEND=noninteractive apt-get install -y moksha moksha-data moksha-menu xorg lightdm lightdm-gtk-greeter network-manager nano pluma firefox-esr || true" >> "$LOG" 2>&1
in-target /bin/sh -c "DEBIAN_FRONTEND=noninteractive apt-get install -y --reinstall educontrol-client" >> "$LOG" 2>&1 || true
in-target /bin/sh -c "if ! dpkg -s educontrol-client >/dev/null 2>&1; then echo '[educontrol] install failed' >> /var/log/aulalliure-late_command.log; apt-cache policy educontrol-client >> /var/log/aulalliure-late_command.log 2>&1 || true; fi" >> "$LOG" 2>&1 || true
in-target systemctl set-default graphical.target >> "$LOG" 2>&1 || true
in-target /bin/sh -c "/usr/sbin/groupadd -f autologin || true; /usr/sbin/groupadd -f nopasswdlogin || true; /usr/sbin/usermod -a -G autologin,nopasswdlogin aulalliure || true; systemctl enable lightdm || true; systemctl daemon-reload || true" >> "$LOG" 2>&1 || true
in-target /bin/sh -c ": > /etc/apt/sources.list; printf '%s\n' 'Types: deb' 'URIs: http://deb.debian.org/debian' 'Suites: trixie trixie-updates' 'Components: main contrib non-free non-free-firmware' 'Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg' '' 'Types: deb' 'URIs: http://security.debian.org/debian-security' 'Suites: trixie-security' 'Components: main contrib non-free non-free-firmware' 'Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg' > /etc/apt/sources.list.d/debian.sources; rm -f /etc/apt/sources.list.d/cdrom*.list /etc/apt/sources.list.d/*cdrom* 2>/dev/null || true; sed -i '/^deb cdrom:/d' /etc/apt/sources.list 2>/dev/null || true" >> "$LOG" 2>&1 || true
{
  mkdir -p /target/var/log/installer
  for f in /var/log/installer/* /var/log/syslog /var/log/messages /var/log/partman /var/log/dpkg.log; do
    [ -f "$f" ] && cp -v "$f" /target/var/log/installer/
  done
} >> "$LOG" 2>&1 || true
{
  echo "=== installer tail logs ==="
  for f in /var/log/syslog /var/log/installer/syslog /var/log/installer/cdebconf /var/log/installer/status /var/log/partman /var/log/messages /var/log/dpkg.log; do
    if [ -f "$f" ]; then
      echo "--- $f ---"
      tail -n 400 "$f"
    fi
  done
  dmesg | tail -n 200
} >> "$LOG" 2>&1 || true
in-target /bin/sh -c "tar -czf /var/log/aulalliure-target-logs.tgz /var/log/apt /var/log/dpkg.log /var/log/alternatives.log /var/log/installer /var/log/syslog /var/log/kern.log 2>/dev/null || true" >> "$LOG" 2>&1 || true

echo "late_command end" >> "$LOG"
cp -f "$LOG" /target/home/aulalliure/.local/state/aulalliure-late_command.log 2>/dev/null || true
chroot /target /bin/sh -c "chown -R aulalliure:aulalliure /home/aulalliure/.local/state" 2>/dev/null || true
printf "%s\n" "ok" > /target/etc/aulalliure/preseed-ran
